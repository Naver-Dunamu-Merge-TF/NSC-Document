# API 명세서 (API Specification)

> **ℹ️ 프로젝트 정보**
> - **Project**: Naver Financial & Dunamu Merge Project (NSC Platform)
> - **Doc ID**: API-2.4 (Rev. 2)
> - **Base URL**: `https://api.nsc-platform.com/v1`
> - **Protocol**: HTTPS / JSON

---

## 1. 공통 사항 (Common)

### 1.1 인증 (Authentication)

모든 API 요청(회원가입/로그인 제외)은 헤더에 JWT Access Token을 포함해야 합니다.

| Header Name | Value Format | Description | Required |
| :--- | :--- | :--- | :---: |
| Authorization | Bearer `<access_token>` | 사용자 인증 토큰 | O |

### 1.2 멱등성 (Idempotency)

**결제 관련 API(POST)**는 네트워크 오류로 인한 중복 결제를 방지하기 위해, 클라이언트가 생성한 고유 키를 헤더에 포함해야 합니다.

| Header Name | Value Format | Description | Required |
| :--- | :--- | :--- | :---: |
| Idempotency-Key | `<UUID-v4>` | 요청 고유 식별자 (Client 생성) | O |

### 1.3 공통 응답 구조 (Response Structure)

모든 응답은 아래의 표준 래퍼(Wrapper) 구조를 따릅니다.

```json
{
  "success": true, // 성공 여부 (Boolean)
  "data": {...},   // 실제 응답 데이터 (Object)
  "error": null    // 에러 발생 시 에러 객체 (Object)
}
```

---

## 2. 지갑 서비스 (Wallet Service)

### 2.1 내 지갑 잔액 조회

- **기능**: 로그인한 사용자의 현재 자산 상태(가용/동결)를 조회합니다.
- **HTTP Method**: `GET`
- **URL**: `/wallet/balance`

**Request Header**

| 이름 | 내용 | 필수 여부 |
| :--- | :--- | :---: |
| Authorization | Bearer `{JWT_TOKEN}` | O |

**Response Body**

| 이름 | 타입 | 설명 | 필수 여부 |
| :--- | :--- | :--- | :---: |
| success | Boolean | 요청 성공 여부 | O |
| data.user_id | String | 사용자 고유 ID | O |
| data.wallet_address | String | 블록체인 지갑 주소 | O |
| data.currency | String | 통화 단위 (NSC) | O |
| data.balance.total | Integer | 총 보유 자산 | O |
| data.balance.available | Integer | 사용 가능 금액 | O |
| data.balance.frozen | Integer | 동결(거래 진행 중) 금액 | O |

### 2.2 충전하기 (Minting)

- **기능**: 연동된 은행 계좌(KRW)에서 자금을 가져와 스테이블 코인(NSC)을 1:1 비율로 발행합니다.
- **HTTP Method**: `POST`
- **URL**: `/wallet/charge`

**Request Body**

| 이름 | 타입 | 설명 | 필수 여부 |
| :--- | :--- | :--- | :---: |
| amount | Integer | 충전할 금액 (KRW) | O |
| bank_name | String | 출금 은행명 | O |
| account_number | String | 출금 계좌 번호 | O |

**Response Body (Data)**

| 이름 | 타입 | 설명 | 필수 여부 |
| :--- | :--- | :--- | :---: |
| tx_id | String | 거래 고유 ID (Transaction ID) | O |
| charged_amount | Integer | 충전 처리된 금액 (KRW) | O |
| current_balance | Integer | 충전 후 최종 잔액 (KRW) | O |
| status | String | 거래 처리 상태 (예: COMPLETED) | O |

---

## 3. 결제 서비스 (Payment Service) - Core

본 서비스는 안정적인 트랜잭션을 위해 **TCC(Try-Confirm-Cancel)** 패턴을 따릅니다.

### 3.1 결제 요청 (동결 - Freeze)

- **기능**: 사용자의 잔액을 즉시 차감하지 않고 '동결(Hold)' 상태로 변경하여 확보합니다. (Try 단계)
- **HTTP Method**: `POST`
- **URL**: `/payment/freeze`

**Request Body**

| 이름 | 타입 | 설명 | 필수 여부 |
| :--- | :--- | :--- | :---: |
| merchant_id | String | 가맹점(판매자) ID | O |
| order_id | String | 주문 번호 (Unique) | O |
| product_name | String | 결제 상품명 | O |
| amount | Integer | 결제 금액 (NSC) | O |

### 3.2 결제 확정 (정산 - Settle)

- **기능**: 동결된 금액을 확정하여 판매자 지갑으로 이전합니다. (Confirm 단계)
- **HTTP Method**: `POST`
- **URL**: `/payment/settle`

**Request Body**

| 이름 | 타입 | 설명 | 필수 여부 |
| :--- | :--- | :--- | :---: |
| tx_id | String | 동결 시 발급받은 트랜잭션 ID | O |
| reason | String | 확정 사유 (예: DELIVERY_STARTED) | X |

### 3.3 결제 취소 (롤백 - Rollback)

- **기능**: 동결된 금액을 해제하고 사용자에게 반환합니다. (Cancel 단계)
- **HTTP Method**: `POST`
- **URL**: `/payment/cancel`

---

## 4. 관리자 및 원장 (Admin & Ledger)

### 4.1 전체 원장 로그 조회

- **기능**: 시스템 내 발생한 모든 트랜잭션 로그를 조회합니다.
- **HTTP Method**: `GET`
- **URL**: `/admin/ledger`

**Query Parameters**

| 이름 | 타입 | 설명 | 필수 여부 |
| :--- | :--- | :--- | :---: |
| page | Integer | 페이지 번호 (기본 1) | X |
| limit | Integer | 조회 개수 (기본 50) | X |
| type | String | 필터링 타입 (PAYMENT, CHARGE 등) | X |

---
 
 ### 4.2 관리자 대시보드 통계 조회
 
 - **기능**: 대시보드 상단에 표시할 핵심 자산 및 사용자 통계를 제공합니다.
 - **HTTP Method**: `GET`
 - **URL**: `/admin/stats`
 - **Response Body**:
   ```json
   {
     "total_supply": 1000000,
     "reserve_krw": 1000000,
     "active_users": 500,
     "today_tx_count": 120
   }
   ```
 
 ### 4.3 인프라 상태 확인 (Health Check)
 
 - **기능**: Azure 리소스 및 Kafka 클러스터의 실시간 상태를 확인합니다.
 - **HTTP Method**: `GET`
 - **URL**: `/admin/health`
 - **Response Body**:
   ```json
   {
     "azure_server": "OK",
     "kafka_cluster": "OK",
     "db_connection": "OK",
     "latency_ms": 15
   }
   ```
 
 ### 4.4 리스크 분석 결과 조회 (OLAP)
 
 - **기능**: Databricks에서 분석된 사용자별 리스크 점수 및 이상 징후를 조회합니다.
 - **HTTP Method**: `GET`
 - **URL**: `/admin/risk-analysis`
 - **Response Body**:
   ```json
   [
     {
       "user_id": "user_123",
       "risk_score": 85,
       "risk_level": "DANGER",
       "reason": "High frequency transactions"
     }
   ]
   ```
 
 ---


## 5. 에러 코드 정의 (Error Codes)

| 코드명 | HTTP Status | 설명 | 조치 방법 |
| :--- | :---: | :--- | :--- |
| `ERR_AUTH_INVALID` | 401 | 유효하지 않은 토큰입니다. | 로그인 페이지로 리다이렉트 |
| `ERR_INSUFFICIENT_FUNDS` | 400 | 잔액이 부족합니다. | 충전 팝업 노출 |
| `ERR_IDEMPOTENCY_CONFLICT` | 409 | 이미 처리된 주문 번호입니다. | 기존 결제 내역 정보 보여주기 |
| `ERR_WALLET_FROZEN` | 403 | 해당 지갑이 정지된 상태입니다. | 고객센터 문의 유도 |
| `ERR_INTERNAL_SERVER` | 500 | 서버 내부 오류 | 잠시 후 재시도 안내 |